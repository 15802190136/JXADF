!function(e){e.extend(e.fn.treegrid.defaults,{onBeforeDrag:function(){},onStartDrag:function(){},onStopDrag:function(){},onDragEnter:function(){},onDragOver:function(){},onDragLeave:function(){},onBeforeDrop:function(){},onDrop:function(){}}),e.extend(e.fn.treegrid.methods,{enableDnd:function(r,t){return e("#treegrid-dnd-style").length||e("head").append('<style id="treegrid-dnd-style">.treegrid-row-top td{border-top:1px solid red}.treegrid-row-bottom td{border-bottom:1px solid red}.treegrid-row-append .tree-title{border:1px solid red}</style>'),r.each(function(){function r(r,t){var d=e(r).draggable("proxy").find("span.tree-dnd-icon");d.removeClass("tree-dnd-yes tree-dnd-no").addClass(t?"tree-dnd-yes":"tree-dnd-no")}function d(r){var t=e(r).attr("node-id");return s.treegrid("find",t)}function o(e,r){function t(){var t=s.treegrid("pop",e[g.idField]);s.treegrid("append",{parent:r[g.idField],data:[t]}),g.onDrop.call(i,r,t,"append")}t(),"closed"==r.state&&s.treegrid("expand",r[g.idField])}function a(e,r,t){var d={};"top"==t?d.before=r[g.idField]:d.after=r[g.idField];var o=s.treegrid("pop",e[g.idField]);d.data=o,s.treegrid("insert",d),g.onDrop.call(i,r,o,t)}var i=this,n=e.data(this,"treegrid");n.disabledNodes=[];var s=e(this),g=n.options;if(t)for(var p=g.finder.getTr(i,t),l=s.treegrid("getChildren",t),f=0;f<l.length;f++)p=p.add(g.finder.getTr(i,l[f][g.idField]));else var p=s.treegrid("getPanel").find("tr[node-id]");p.draggable({disabled:!1,revert:!0,cursor:"pointer",proxy:function(r){var t=s.treegrid("find",e(r).attr("node-id")),d=e('<div class="tree-node-proxy"></div>').appendTo("body");return d.html('<span class="tree-dnd-icon tree-dnd-no">&nbsp;</span>'+t[g.treeField]),d.hide(),d},deltaX:15,deltaY:15,onBeforeDrag:function(r){return 0==g.onBeforeDrag.call(i,d(this))?!1:e(r.target).hasClass("tree-hit")||e(r.target).parent().hasClass("datagrid-cell-check")?!1:1!=r.which?!1:void e(this).next("tr.treegrid-tr-tree").find("tr[node-id]").droppable({accept:"no-accept"})},onStartDrag:function(){e(this).draggable("proxy").css({left:-1e4,top:-1e4});var r=d(this);g.onStartDrag.call(i,r),n.draggingNodeId=r[g.idField]},onDrag:function(r){var t=r.pageX,d=r.pageY,o=r.data.startX,a=r.data.startY,n=Math.sqrt((t-o)*(t-o)+(d-a)*(d-a));if(n>3){e(this).draggable("proxy").show();var s=g.finder.getTr(i,e(this).attr("node-id")),p=s.find("span.tree-title");r.data.startX=p.offset().left,r.data.startY=p.offset().top,r.data.offsetWidth=0,r.data.offsetHeight=0}this.pageY=r.pageY},onStopDrag:function(){e(this).next("tr.treegrid-tr-tree").find("tr[node-id]").droppable({accept:"tr[node-id]"});for(var r=0;r<n.disabledNodes.length;r++){var t=g.finder.getTr(i,n.disabledNodes[r]);t.droppable("enable")}n.disabledNodes=[];var d=s.treegrid("find",n.draggingNodeId);g.onStopDrag.call(i,d)}}).droppable({accept:"tr[node-id]",onDragEnter:function(t,o){if(0==g.onDragEnter.call(i,d(this),d(o))){r(o,!1);var a=g.finder.getTr(i,e(this).attr("node-id"));a.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),a.droppable("disable"),n.disabledNodes.push(e(this).attr("node-id"))}},onDragOver:function(t,o){var a=e(this).attr("node-id");if(!(e.inArray(a,n.disabledNodes)>=0)){var s=o.pageY,p=e(this).offset().top,l=p+e(this).outerHeight();r(o,!0);var f=g.finder.getTr(i,a);f.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),f.addClass(s>p+(l-p)/2?5>l-s?"treegrid-row-bottom":"treegrid-row-append":5>s-p?"treegrid-row-top":"treegrid-row-append"),0==g.onDragOver.call(i,d(this),d(o))&&(r(o,!1),f.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),f.droppable("disable"),n.disabledNodes.push(a))}},onDragLeave:function(t,o){r(o,!1);var a=g.finder.getTr(i,e(this).attr("node-id"));a.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"),g.onDragLeave.call(i,d(this),d(o))},onDrop:function(r,t){var n,s,p=g.finder.getTr(i,e(this).attr("node-id"));p.hasClass("treegrid-row-append")?(n=o,s="append"):(n=a,s=p.hasClass("treegrid-row-top")?"top":"bottom");var l=d(this),f=d(t);return 0==g.onBeforeDrop.call(i,l,f,s)?void p.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"):(n(f,l,s),void p.removeClass("treegrid-row-append treegrid-row-top treegrid-row-bottom"))}})})}})}(jQuery);