var JxMenu=function(){var t=function(t,e){this.menuDiv="object"==typeof e?e:$("#"+e);var n={idKey:"app",pIdKey:"parent",menuData:null,iconBase:""};this.setting=$.extend(n,t),this.initData(),e.addClass("jxMenuDiv"),"en"==langCode&&$(".popupWin").addClass("en")},e=null;return t.prototype.transformToTreeData=function(t){var e,n,i=t.idKey,a=t.pIdKey,p=t.menuData;if(childKey="children",!i||""==i||!p)return[];var o=[],u=[];for(e=0,n=p.length;n>e;e++)u[p[e][i]]=p[e];for(e=0,n=p.length;n>e;e++)u[p[e][a]]&&p[e][i]!=p[e][a]?(u[p[e][a]][childKey]||(u[p[e][a]][childKey]=[]),u[p[e][a]][childKey].push(p[e])):o.push(p[e]);return o},t.prototype.mouseOverEventHandler=function(t){e&&clearTimeout(e);var n,i=$(this).offset().top-t.data.menuDiv.position().top,a=$(window).height(),p=t.data.menuDiv.outerHeight(),o=$(document).scrollTop(),u=a-(i-o),r=$(".subMenu",$(this)[0].parentNode),s=$(".popupWin"),d=20,l=r.children();if(l.length<=0)return s.hide(),!1;var c=l.clone(!0);c.last().css({"border-bottom":"none","margin-bottom":"0"}),r.hide(),t.data.curSubMenu=c,s.removeAttr("style").html("<div class='popupWin_bg'></div><div class='popupWin_content'></div>").find(".popupWin_content").append(c).show(),subMenuHeight=s.height(),u>=subMenuHeight?n=i:subMenuHeight>u&&p>subMenuHeight?n=o+a-subMenuHeight-5:(subMenuHeight=p-d,n=o-t.data.menuDiv.position().top);var m=n-t.data.menuDiv.parent().position().top;0>m&&(m=0),s.css({top:m,left:"246px",height:subMenuHeight,display:"block"})},t.prototype.mouseOutEventHandler=function(){e=setTimeout(function(){$(".popupWin").hide()},20)},t.prototype.createMenu=function(t,e){if(null!=t)for(var n=this.menuDiv,i=!1,a=0;a<t.length;a++){if(!t[a].parent){var p=$("<img/> ").addClass("moduleIcon").attr("src",this.setting.iconBase+"blank.gif"),o=$("<div/> ").addClass("menuContainer").append($("<span/> ").addClass("triangleRight")).append(p).append($("<div/> ").attr("id",t[a].app).addClass("menuItem").text(t[a].description).attr("appUrl",t[a].appUrl).attr("app",t[a].app).attr("appId",t[a].maxAppsId)),u=$("<div/>").addClass("topMenu");u.append(o).appendTo(n);var r=this.setting.iconBase+"menu/"+t[a].app.toLowerCase()+".png";this.imgLoad(r,p),null!=t[a].children&&this.createMenu(t[a].children,$("<div/>").addClass("subMenu").appendTo(u))}if("MODULE"==t[a].appType&&t[a].parent){i=!1;var s=$("<dt/>").text(t[a].description).attr("appUrl",t[a].appUrl).attr("app",t[a].app).attr("appId",t[a].maxAppsId);("DL"==e[0].tagName||"DD"==e[0].tagName)&&(e=e.closest(".subMenu"));var d=$("<dl/>").append(s).appendTo(e);null!=t[a].children&&this.createMenu(t[a].children,d)}"APP"==t[a].appType&&e&&("DL"!=e[0].tagName&&"DD"!=e[0].tagName&&(e=$("<dl/>").appendTo(e)),i?$("<em/>").text(t[a].description).attr("appUrl",t[a].appUrl).attr("app",t[a].app).attr("appId",t[a].maxAppsId).appendTo(e):(e=$("<dd/>").append($("<em/>").text(t[a].description).attr("appUrl",t[a].appUrl).attr("app",t[a].app).attr("appId",t[a].maxAppsId)).appendTo(e),i=!0))}},t.prototype.menuClickEventHandler=function(t){void 0!=$(this).attr("appUrl")&&""!=$(this).attr("appUrl")&&"function"==typeof t.data.onMenuClick&&(t.data.curSubMenu&&t.data.curSubMenu.toggle(),t.data.onMenuClick(t),$(".popupWin").hide())},t.prototype.menuHisBtnClickEventHandler=function(t){var e=$(".popupWin"),n=$("#menuAppBar");e.css({top:n.position().top+n.outerHeight(),left:"22px",height:"250px"}),e.is(":visible")||(WebClientBean.getMenuHisData(function(t){function n(t,n){for(var i=$("<dt/>").text(n),a=$("<dd/>"),p=0;p<t.length;p++)$("<em/>").text(t[p].DESCRIPTION).attr("appUrl",t[p].APPURL).attr("app",t[p].APP).appendTo(a);$("<dl/>").addClass("subMemuFont").append(i).append(a).appendTo(e)}e.empty(),null!=t&&(n(t.favoriteApp,getLangString("home.myFavorite")),n(t.recentApp,getLangString("home.recentVisit")))}),t.data.curSubMenu=e),e.toggle()},t.prototype.loadModuleImg=function(t,e){var n=$(t).find(".moduleIcon"),i=$(t).find(".menuItem"),a=this.setting.iconBase+"menu/"+i.attr("ID").toLowerCase()+e+".png";this.imgLoad(a,n)},t.prototype.initData=function(){if(null!=this.setting.menuData){var t=$(".popupWin"),n=this.transformToTreeData(this.setting);this.menuDiv.on("mouseenter",".menuContainer",this,this.mouseOverEventHandler),this.menuDiv.on("mouseleave",".menuContainer",$.proxy(this.mouseOutEventHandler,this)),this.menuDiv.on("click",".menuItem, .subMenu dt, .subMenu  em",this,this.menuClickEventHandler),$(".visitHisBtn").on("click",null,this,this.menuHisBtnClickEventHandler),this.autoComplete(),t.on("click","em",this,this.menuClickEventHandler),t.on("mouseleave",function(){$(this).hide()}).on("mouseenter",$.proxy(function(){e&&clearTimeout(e)},this)),this.createMenu(n,null);var i=this;this.menuDiv.find(".topMenu").hover(function(){i.loadModuleImg(this,"_hover")},function(){i.loadModuleImg(this,"")})}},t.prototype.autoComplete=function(){var t=[];$.each(this.setting.menuData,function(e,n){t.push({label:n.description,value:n.description,target:"#mainMenu [appid="+n.maxAppsId+"]",appUrl:n.appUrl})});var e=$.fn.menu;$.widget.bridge("menu",$.ui.menu),$(".input-txt","#menuAppBar").autocomplete({source:t,select:function(t,e){$(e.item.target).trigger(e.item.appUrl?"click":"mouseover")}}).on("keypress",function(t){var e=$(".ui-autocomplete");e.is(":visible")&&13==t.keyCode&&(e.find("a").eq(0).trigger("click"),$(this).blur())}).on("focusin",function(){$(".popupWin").hide(),$(this).val("")}),$.fn.menu=e},t.prototype.imgLoad=function(t,e){var n=new Image;n.src=t,n.complete?e.attr("src",t):n.onload=function(){e.attr("src",t),n.onload=null}},t}();